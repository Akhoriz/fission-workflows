syntax = "proto3";

option go_package = "types";

import "google/protobuf/timestamp.proto";

// Common
message ObjectMetadata {
    string id = 1;
    //    string namespace = 2;
    //    string name = 3;
    google.protobuf.Timestamp createdAt = 3;
}

// Workflow Model
message Workflow {
    ObjectMetadata metadata = 1;
    WorkflowSpec spec = 2;
    WorkflowStatus status = 3;
}

message WorkflowSpec {
    string name = 1;
    string version = 2;
    WorkflowDefinition src = 3;
}

// Function Invocation Model
message FunctionInvocation {
    ObjectMetadata metadata = 1;
    FunctionInvocationSpec spec = 2;
    FunctionInvocationStatus status = 3;
}

message FunctionInvocationSpec {
    // Id of the function to be invoked (no ambiguatity at this point
    TaskTypeDef type = 1;
    string taskId = 2; // task in workflow
    map<string, TypedValue> inputs = 3;
}

message FunctionInvocationStatus {
    enum Status {
        UNKNOWN = 0;
        SCHEDULED = 1; // Arrived at engine, but not yet schedu
        IN_PROGRESS = 2; // Scheduled
        SUCCEEDED = 3;
        FAILED = 4;
        ABORTED = 5;
        SKIPPED = 6;
    }
    Status status = 1;
    google.protobuf.Timestamp updatedAt = 2;
    TypedValue output = 3;
}

// Workflow Invocation Model
message WorkflowInvocationSpec {
    string workflowId = 1;
    map<string, TypedValue> input = 3;
}

message WorkflowInvocationStatus {
    enum Status {
        UNKNOWN = 0;
        SCHEDULED = 1; // Arrived at engine, but not yet schedu
        IN_PROGRESS = 2; // Scheduled
        SUCCEEDED = 3;
        FAILED = 4;
        ABORTED = 5;
        //PAUSED = 6;
    }
    Status status = 1;
    google.protobuf.Timestamp updatedAt = 2;
    map<string, FunctionInvocation> tasks = 3;
    TypedValue output = 4;
}


message WorkflowInvocation {
    ObjectMetadata metadata = 1;
    WorkflowInvocationSpec spec = 2;
    WorkflowInvocationStatus status = 3;
}

// Workflow Definition
//
// The workflowDefinition contains the definition of a workflow.
//
// Ideally the source code (json, yaml) can be converted directly to this message.
// Naming, triggers and versioning of the workflow itself is out of the scope of this data structure, which is delegated
// to the user/system upon the creation of a workflow.
message WorkflowDefinition {
    // apiVersion describes what version is of the workflow definition.
    //
    // By default the workflow engine will assume the latest version to be used.
    string apiVersion = 1;

    // TODO Parameters
    // Actions
    //
    // Dependency graph is build into the tasks
    map<string, Task> tasks = 2; // key = taskId

    // From which task should the workflow return the output? Future: multiple? Implicit?
    string outputTask = 3;
}

// A task is the primitive unit of a workflow, representing an action that needs to be performed in order to continue.
//
// A task as a number of inputs and exactly two outputs
// Id is specified outside of task
message Task {

    // Type defines the type of the task that needs to be performed
    //
    // By default the following types are supported:
    // - `function`: execute a function.
    // - `exit`: Once this task is executed, the controller will exit the workflow, canceling all running tasks.
    string type = 2;

    // Name/identifier of the function
    string name = 3;

    map<string, TypedValue> inputs = 4;

    // Dependencies for this task to execute
    map<string, TaskDependencyParameters> dependencies = 5;

    // Number of dependencies to wait for
    int32 dependencies_await = 6;
}

message TaskDependencyParameters {

    enum DependencyType {
        DATA = 0;
        CONTROL = 1;
    }
    DependencyType type = 1;
    string alias = 2;
}

// Internal
message WorkflowStatus {
    enum Status {
        UNKNOWN = 0;
        PARSING = 1; // During validation/parsing
        READY = 2;
        FAILED = 3;
        DELETED = 4;
    }
    Status status = 1;
    google.protobuf.Timestamp updatedAt = 2;
    map<string, TaskTypeDef> resolvedTasks = 3; // Key = taskId
}

message TaskTypeDef {
    string src = 1; // Orginal
    string runtime = 2; // Function Runtime
    string resolved = 3; // Address (Uid) to the function
}

// Copy of protobuf's Any, to avoid protobuf requirement of a protobuf-based type.
message TypedValue {
    string type = 1;
    bytes value = 2;
}
